# Habito - Claude Context

## Project Overview
A habit tracking app with a retro terminal aesthetic (green on black, monospace fonts). Built with React + Vite, uses Supabase for backend.

## Key Architecture Decisions

### Data Storage
- **habits table**: Main habit data including `streak`, `completed_today`, `completions_today`, `history` (7-day array), `position`, `scheduled_time`, `scheduled_days`
- **completions table**: Historical record of completions by date (source of truth for streak calculations)
- **localStorage cache**: `habito_habits_cache_v2` for faster initial loads

### Streak Calculation
Streaks are calculated from the `completions` table, NOT the `habits.streak` field directly.

**Important lessons learned:**
1. When calculating streaks, start from the **most recent completed date** and count backwards - NOT from today
2. If completions table is empty/sparse, fall back to the `history` array on the habit
3. Never reset streaks during day-change logic - let the recalculation effect handle it
4. When `calculateStreakForHabit` returns `null`, preserve the existing streak value
5. Always default `habit.streak` to 0 if undefined: `const currentStreak = habit.streak || 0`

### Day Change Logic (`checkDayChange`)
- Shifts the `history` array and resets `completed_today`/`completions_today`
- Does NOT touch streaks - streak recalculation happens separately
- Triggered by comparing `localStorage.lastVisit` to current date

### Data Sync
- Cache is invalidated by changing the cache key version (e.g., `_v2`)
- Visibility change handler refetches data when tab becomes active (cross-device sync)
- Background fetches run without timeout when cache exists

## Common Gotchas

### Mobile Touch Events
- Use CSS `touch-action: pan-y` instead of `e.preventDefault()` to handle horizontal swipes
- React adds touch listeners as passive by default, so `preventDefault()` throws errors

### Supabase Timeouts
- Auth refresh can be slow, causing fetch timeouts
- Show cached data immediately, fetch fresh data in background without aggressive timeouts

### State Updates
- When updating habits, always handle null/undefined values: `habit.streak || 0`
- Optimistic updates should include all fields being changed

## File Structure
- `src/components/HabitTracker.jsx` - Main component (large file ~3000+ lines)
- `src/components/BottomSheet.jsx` - Reusable modal/bottom sheet component
- `src/hooks/useCompletions.js` - Hook for recording completions to completions table
- `src/lib/supabase.js` - Supabase client setup
- `src/lib/capacitor.js` - Capacitor platform detection and native features
- `src/services/haptics.js` - Haptic feedback utilities
- `src/services/notifications.js` - Local notification scheduling
- `supabase/migrations/` - Database migrations
- `capacitor.config.json` - Capacitor app configuration
- `ios/` - Native iOS project (generated by Capacitor)

## Styling Conventions
- Terminal aesthetic: green (#00ff41) on black (#0a0a0a)
- Gray scale: #666 (icons), #777 (badges), #888 (labels), #999 (text)
- Mobile uses slightly larger fonts than desktop
- Monospace font family: IBM Plex Mono, Fira Code, SF Mono

## iOS Native App (Capacitor)

### Setup
- App ID: `app.habitos`
- App Name: `Habit_OS`
- Uses Capacitor 6.x to wrap the React web app
- iOS project in `ios/App/`

### Safe Area Handling
**Critical**: iOS safe areas (Dynamic Island, notch) require careful handling:
- `capacitor.config.json` has `contentInset: "automatic"` which handles some safe area adjustments
- The mobile header uses CSS `top: env(safe-area-inset-top)` to position below the Dynamic Island
- The header spacer uses `height: calc(135px + env(safe-area-inset-top))` to push content below
- **Do NOT use padding-top for safe area on the header** - use `top` positioning instead
- `overflow: hidden` or `overflow-x: hidden` on parent containers breaks `position: fixed` in iOS WebView - avoid these on the main container

### Splash Screen
- Configured to NOT auto-hide (`launchAutoHide: false`)
- App manually hides splash after boot animation completes via `hideSplashScreen()`
- This prevents a flash/broken screen between native splash and React app load

### Mobile Header
- Uses `.mobile-header` CSS class (defined in `index.css`)
- Fixed position at top with safe area offset
- Spacer div with `.mobile-header-spacer` class pushes content below header
- Header height is approximately 135px (without safe area)

### Boot Animation
- Shows terminal-style boot messages on app launch
- Ends with "> ready_" with blinking cursor
- Fades out smoothly before transitioning to main app
- `hideSplashScreen()` is called after boot animation completes

### Haptics
- Use `hapticMedium()` for habit completions
- Use `hapticLight()` for button taps
- Use `hapticSuccess()` for 100% daily completion
- Only triggers on native platform (no-op on web)

### AutoFocus on Mobile
- Set `autoFocus={!isMobile}` on form inputs in modals
- Prevents keyboard from auto-opening on iOS when modals open

## BottomSheet Component
- Slides up from bottom on mobile, centered modal on desktop
- Takes `isMobile` prop to determine behavior
- Has safe area padding at bottom for iPhone home indicator
- Header padding: `16px 20px 12px` on mobile
- Content padding: `8px 20px 20px` on mobile
